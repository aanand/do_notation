# to run: "spec test/simulations.rb"

require File.join(File.dirname(__FILE__), %w(.. init))
require File.join(File.dirname(__FILE__), %w(.. lib simulations))

roll_3d6 = proc do
  d1 <- rand(6)
  d2 <- rand(6)
  d3 <- rand(6)
  
  unit(1+d1 + 1+d2 + 1+d3)
end

roll_3d6_b = proc do
  d1 <- rand(6)
  d2 <- rand(6)
  d3 <- rand(6)
  
  if [d1, d2, d3].include?(5)
    rand(6).bind{|d4| unit(1+d1 + 1+d2 + 1+d3 + 1+d4) }
  else
    unit(1+d1 + 1+d2 + 1+d3)
  end
end

describe "Simulation" do
  specify "generates correct answers" do
    Simulation.run(&roll_3d6).play.should   == 9
    Simulation.run(&roll_3d6_b).play.should == 9
  end
end

describe "Distribution" do
  specify "generates correct answers" do
    Distribution.run(&roll_3d6).play.inspect.should == "[[3, 0.00462962962962963], [4, 0.0138888888888889], [5, 0.0277777777777778], [6, 0.0462962962962963], [7, 0.0694444444444444], [8, 0.0972222222222222], [9, 0.115740740740741], [10, 0.125], [11, 0.125], [12, 0.115740740740741], [13, 0.0972222222222222], [14, 0.0694444444444444], [15, 0.0462962962962963], [16, 0.0277777777777778], [17, 0.0138888888888889], [18, 0.00462962962962963]]"
    Distribution.run(&roll_3d6_b).play.inspect.should == "[[3, 0.00462962962962963], [4, 0.0138888888888889], [5, 0.0277777777777778], [6, 0.0462962962962963], [7, 0.0694444444444444], [8, 0.0833333333333333], [9, 0.0902777777777777], [10, 0.0902777777777778], [11, 0.0833333333333333], [12, 0.0694444444444445], [13, 0.0625000000000001], [14, 0.0601851851851853], [15, 0.0578703703703705], [16, 0.0555555555555557], [17, 0.0532407407407408], [18, 0.0462962962962964], [19, 0.0354938271604938], [20, 0.0239197530864198], [21, 0.0146604938271605], [22, 0.00771604938271605], [23, 0.00308641975308642], [24, 0.000771604938271605]]"
  end
end

describe "Expectation" do
  specify "generates correct answers" do
    (1..21).collect { |x| Expectation.run(&roll_3d6).play(x) }.inspect.should == "[0.0, 0.0, 0.00462962962962963, 0.0138888888888889, 0.0277777777777778, 0.0462962962962963, 0.0694444444444444, 0.0972222222222222, 0.115740740740741, 0.125, 0.125, 0.115740740740741, 0.0972222222222222, 0.0694444444444444, 0.0462962962962963, 0.0277777777777778, 0.0138888888888889, 0.00462962962962963, 0.0, 0.0, 0.0]"
    (1..21).collect { |x| Expectation.run(&roll_3d6_b).play(x) }.inspect.should == "[0.0, 0.0, 0.00462962962962963, 0.0138888888888889, 0.0277777777777778, 0.0462962962962963, 0.0694444444444444, 0.0833333333333333, 0.0902777777777778, 0.0902777777777777, 0.0833333333333333, 0.0694444444444444, 0.0625, 0.0601851851851852, 0.0578703703703704, 0.0555555555555556, 0.0532407407407407, 0.0462962962962963, 0.0354938271604938, 0.0239197530864197, 0.0146604938271605]"
  end
end